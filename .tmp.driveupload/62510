package com.example.crimeplatformapi.controller;

import com.example.crimeplatformapi.dto.PersonDTO;
import com.example.crimeplatformapi.entity.Persons;
import com.example.crimeplatformapi.entity.UserAccounts;
import com.example.crimeplatformapi.repository.UserAccountsRepository;
import com.example.crimeplatformapi.service.PersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/persons")
public class PersonController {

    @Autowired
    private PersonService personService;

    @Autowired
    private UserAccountsRepository userAccountsRepository;

    @GetMapping
    public List<Map<String, Object>> getAllPersons() {
        List<PersonDTO> personsList = personService.findAllPersons().stream()
                .map(this::convertToDto)
                .collect(Collectors.toList());
        
        List<UserAccounts> nonAdminUsers = userAccountsRepository.findByUserTypeNot("管理员");
        
        Map<String, PersonDTO> personMap = personsList.stream()
                .collect(Collectors.toMap(PersonDTO::idNumber, p -> p));
        
        for (UserAccounts user : nonAdminUsers) {
            if (user.getIdNumber() != null && !user.getIdNumber().trim().isEmpty()) {
                if (!personMap.containsKey(user.getIdNumber())) {
                    PersonDTO personDTO = new PersonDTO(
                        user.getIdNumber(),
                        user.getRealName() != null ? user.getRealName() : "未知",
                        "未知",
                        null,
                        null,
                        user.getUsername()
                    );
                    personMap.put(user.getIdNumber(), personDTO);
                }
            }
        }
        
        return personMap.values().stream().map(p -> {
            Map<String, Object> map = new HashMap<>();
            map.put("idNumber", p.idNumber());
            map.put("name", p.name());
            map.put("gender", p.gender());
            map.put("birthDate", p.birthDate());
            map.put("address", p.address());
            map.put("contactInfo", p.contactInfo());
            return map;
        }).collect(Collectors.toList());
    }

    @PostMapping
    public ResponseEntity<?> createPerson(@RequestBody Persons person) {
        try {
            Persons newPerson = personService.createPerson(person);
            return new ResponseEntity<>(convertToDto(newPerson), HttpStatus.CREATED);
        } catch (IllegalArgumentException ex) {
            return ResponseEntity.badRequest().body(Map.of("message", ex.getMessage()));
        }
    }

    @GetMapping("/{id}")
    public ResponseEntity<PersonDTO> getPerson(@PathVariable String id) {
        Persons p = personService.findById(id);
        return ResponseEntity.ok(convertToDto(p));
    }

    @PutMapping("/{id}")
    public ResponseEntity<?> updatePerson(@PathVariable String id, @RequestBody Persons payload) {
        try {
            Persons p = personService.update(id, payload);
            return ResponseEntity.ok(convertToDto(p));
        } catch (IllegalArgumentException ex) {
            return ResponseEntity.badRequest().body(Map.of("message", ex.getMessage()));
        }
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<?> deletePerson(@PathVariable String id) {
        try {
            personService.delete(id);
            return ResponseEntity.noContent().build();
        } catch (IllegalArgumentException ex) {
            return ResponseEntity.badRequest().body(Map.of("message", ex.getMessage()));
        }
    }

    @DeleteMapping("/cleanup-invalid")
    public ResponseEntity<Map<String, Object>> cleanupInvalidPersons() {
        int deleted = personService.deleteInvalidPersons();
        return ResponseEntity.ok(Map.of("deleted", deleted));
    }

    private PersonDTO convertToDto(Persons entity) {
        return new PersonDTO(
            entity.getIdNumber(),
            entity.getName(),
            entity.getGender(),
            entity.getBirthDate(),
            entity.getAddress(),
            entity.getContactInfo()
        );
    }
}