package com.example.crimeplatformapi.controller;

import com.example.crimeplatformapi.dto.OfficerDTO;
import com.example.crimeplatformapi.entity.Officers;
import com.example.crimeplatformapi.repository.CasesRepository;
import com.example.crimeplatformapi.repository.OfficersRepository;
import jakarta.transaction.Transactional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import com.example.crimeplatformapi.util.Java17Compat;
import java.util.List;
import java.util.stream.Collectors;
import java.util.Optional;

@RestController
@RequestMapping("/api/officers")
public class OfficerController {

    @Autowired
    private OfficersRepository officersRepository;

    @Autowired
    private CasesRepository casesRepository;

    @GetMapping
    public List<OfficerDTO> getAllOfficers() {
        return officersRepository.findAll().stream()
                .map(this::convertToDto)
                .collect(Collectors.toList());
    }

    @PostMapping
    public ResponseEntity<?> createOfficer(@RequestBody CreateOfficerRequest request) {
        try {
            if (officersRepository.findById(request.officerId()).isPresent()) {
                return ResponseEntity.status(HttpStatus.CONFLICT)
                    .body(Java17Compat.mapOf("message", "警员编号已存在"));
            }
            
            Officers officer = new Officers();
            officer.setOfficerId(request.officerId());
            officer.setDepartment(request.department());
            officer.setPosition(request.position());
            officer.setName(request.name());
            officer.setIdNumber(request.idNumber());
            officer.setGender(request.gender());
            officer.setBirthDate(request.birthDate());
            officer.setAddress(request.address());
            officer.setContactInfo(request.contactInfo());
            
            Officers savedOfficer = officersRepository.save(officer);
            
            return new ResponseEntity<>(convertToDto(savedOfficer), HttpStatus.CREATED);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(Java17Compat.mapOf("message", String.format("创建警员失败: %s", e.getMessage())));
        }
    }

    @GetMapping("/{id}")
    public ResponseEntity<OfficerDTO> getOfficer(@PathVariable String id) {
        Optional<Officers> officerOpt = officersRepository.findById(id);
        if (Java17Compat.isEmpty(officerOpt)) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(convertToDto(officerOpt.get()));
    }

    @PutMapping("/{id}")
    public ResponseEntity<OfficerDTO> updateOfficer(@PathVariable String id, @RequestBody CreateOfficerRequest request) {
        Optional<Officers> officerOpt = officersRepository.findById(id);
        if (Java17Compat.isEmpty(officerOpt)) {
            return ResponseEntity.notFound().build();
        }
        
        Officers officer = officerOpt.get();
        
        officer.setDepartment(request.department());
        officer.setPosition(request.position());
        officer.setName(request.name());
        officer.setIdNumber(request.idNumber());
        officer.setGender(request.gender());
        officer.setBirthDate(request.birthDate());
        officer.setAddress(request.address());
        officer.setContactInfo(request.contactInfo());
        
        Officers savedOfficer = officersRepository.save(officer);
        
        return ResponseEntity.ok(convertToDto(savedOfficer));
    }

    @DeleteMapping("/{id}")
    @Transactional
    public ResponseEntity<Void> deleteOfficer(@PathVariable String id) {
        Optional<Officers> officerOpt = officersRepository.findById(id);
        if (Java17Compat.isEmpty(officerOpt)) {
            return ResponseEntity.notFound().build();
        }
        
        Officers officer = officerOpt.get();

        casesRepository.findAllByOfficerId(id).forEach(c -> {
            c.getOfficers().removeIf(o -> id.equals(o.getOfficerId()));
            casesRepository.save(c);
        });

        officersRepository.delete(officer);
        
        return ResponseEntity.noContent().build();
    }

    private OfficerDTO convertToDto(Officers entity) {
        return new OfficerDTO(
            entity.getOfficerId(),
            entity.getDepartment(),
            entity.getPosition(),
            new com.example.crimeplatformapi.dto.PersonDTO(
                entity.getIdNumber(),
                entity.getName(),
                entity.getGender(),
                entity.getBirthDate(),
                entity.getAddress(),
                entity.getContactInfo()
            )
        );
    }

    public record CreateOfficerRequest(
        String officerId,
        String department,
        String position,
        String name,
        String idNumber,
        String gender,
        java.time.LocalDate birthDate,
        String address,
        String contactInfo
    ) {}
}

