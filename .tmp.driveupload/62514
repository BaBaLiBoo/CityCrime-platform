package com.example.crimeplatformapi.controller;

import com.example.crimeplatformapi.entity.*;
import com.example.crimeplatformapi.repository.*;
import com.example.crimeplatformapi.util.Java17Compat;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeParseException;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.regex.Pattern;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private UserAccountsRepository userAccountsRepository;
    
    @Autowired
    private PersonsRepository personsRepository;
    
    @Autowired
    private OfficersRepository officersRepository;

    public static class LoginRequest {
        private String username;
        private String password;
        
        public LoginRequest() {}
        
        public LoginRequest(String username, String password) {
            this.username = username;
            this.password = password;
        }
        
        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }
        public String getPassword() { return password; }
        public void setPassword(String password) { this.password = password; }
    }
    
    public static class RegisterRequest {
        private String username;
        private String password;
        private String userType;
        private String realName;
        private String idNumber;
        private String gender;
        private String birthDate;
        private String address;
        private String contactInfo;
        private String officerId;
        
        public RegisterRequest() {}
        
        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }
        public String getPassword() { return password; }
        public void setPassword(String password) { this.password = password; }
        public String getUserType() { return userType; }
        public void setUserType(String userType) { this.userType = userType; }
        public String getRealName() { return realName; }
        public void setRealName(String realName) { this.realName = realName; }
        public String getIdNumber() { return idNumber; }
        public void setIdNumber(String idNumber) { this.idNumber = idNumber; }
        public String getGender() { return gender; }
        public void setGender(String gender) { this.gender = gender; }
        public String getBirthDate() { return birthDate; }
        public void setBirthDate(String birthDate) { this.birthDate = birthDate; }
        public String getAddress() { return address; }
        public void setAddress(String address) { this.address = address; }
        public String getContactInfo() { return contactInfo; }
        public void setContactInfo(String contactInfo) { this.contactInfo = contactInfo; }
        public String getOfficerId() { return officerId; }
        public void setOfficerId(String officerId) { this.officerId = officerId; }
    }
    
    public static class VerifyIdentityRequest {
        private String idNumber;
        private String realName;
        
        public VerifyIdentityRequest() {}
        
        public String getIdNumber() { return idNumber; }
        public void setIdNumber(String idNumber) { this.idNumber = idNumber; }
        public String getRealName() { return realName; }
        public void setRealName(String realName) { this.realName = realName; }
    }

    public static class UpdateProfileRequest {
        private String realName;
        private String idNumber;
        private String gender;
        private String birthDate;
        private String address;
        private String contactInfo;

        public String getRealName() { return realName; }
        public void setRealName(String realName) { this.realName = realName; }
        public String getIdNumber() { return idNumber; }
        public void setIdNumber(String idNumber) { this.idNumber = idNumber; }
        public String getGender() { return gender; }
        public void setGender(String gender) { this.gender = gender; }
        public String getBirthDate() { return birthDate; }
        public void setBirthDate(String birthDate) { this.birthDate = birthDate; }
        public String getAddress() { return address; }
        public void setAddress(String address) { this.address = address; }
        public String getContactInfo() { return contactInfo; }
        public void setContactInfo(String contactInfo) { this.contactInfo = contactInfo; }
    }

    public static class ChangePasswordRequest {
        private String oldPassword;
        private String newPassword;

        public String getOldPassword() { return oldPassword; }
        public void setOldPassword(String oldPassword) { this.oldPassword = oldPassword; }
        public String getNewPassword() { return newPassword; }
        public void setNewPassword(String newPassword) { this.newPassword = newPassword; }
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest req) {
        Optional<UserAccounts> userOpt = userAccountsRepository.findByUsername(req.getUsername());
        if (!userOpt.isPresent()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "用户名或密码错误");
            return ResponseEntity.status(401).body(response);
        }
        UserAccounts ua = userOpt.get();
        if (!ua.getPasswordHash().equals(req.getPassword())) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "用户名或密码错误");
            return ResponseEntity.status(401).body(response);
        }
        String token = String.format("dummy-token-%d", ua.getUserId());
        String userType = ua.getUserType();
        if (userType == null || userType.trim().isEmpty()) {
            userType = "普通用户";
        }
        Map<String, Object> response = new HashMap<>();
        response.put("token", token);
        response.put("userType", userType);
        response.put("userId", ua.getUserId());
        response.put("username", ua.getUsername());
        System.out.println("Login - Username: " + ua.getUsername() + ", UserType: " + userType);
        return ResponseEntity.ok(response);
    }

    @GetMapping("/me")
    public ResponseEntity<?> me(@RequestHeader(value = "Authorization", required = false) String auth) {
        Integer userId = extractUserIdFromAuthHeader(auth);
        if (userId == null) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "未认证");
            return ResponseEntity.status(401).body(response);
        }
        Optional<UserAccounts> user = userAccountsRepository.findById(userId);
        if (!user.isPresent()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "用户不存在");
            return ResponseEntity.status(401).body(response);
        }
        UserAccounts ua = user.get();
        String officerId = (ua.getOfficer() != null) ? ua.getOfficer().getOfficerId() : null;
        Persons person = null;
        String idNumberForLookup = ua.getIdNumber();
        if (idNumberForLookup != null) {
            person = personsRepository.findById(idNumberForLookup).orElse(null);
        }
        Map<String, Object> response = new HashMap<>();
        response.put("userId", ua.getUserId());
        response.put("username", ua.getUsername());
        response.put("userType", ua.getUserType());
        response.put("officerId", officerId);
        response.put("idNumber", ua.getIdNumber());
        response.put("realName", ua.getRealName());
        response.put("gender", person != null ? person.getGender() : null);
        response.put("birthDate", person != null && person.getBirthDate() != null ? person.getBirthDate().toString() : null);
        response.put("address", person != null ? person.getAddress() : null);
        response.put("contactInfo", person != null ? person.getContactInfo() : null);
        return ResponseEntity.ok(response);
    }

    @PostMapping("/register")
    @org.springframework.transaction.annotation.Transactional
    public ResponseEntity<?> register(@RequestBody RegisterRequest req) {
        if (req.getUsername() == null || req.getUsername().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "用户名不能为空");
            return ResponseEntity.badRequest().body(response);
        }
        if (req.getPassword() == null || req.getPassword().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "密码不能为空");
            return ResponseEntity.badRequest().body(response);
        }
        if (userAccountsRepository.findByUsername(req.getUsername()).isPresent()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "用户名已存在");
            return ResponseEntity.status(409).body(response);
        }
        if (req.getRealName() == null || req.getRealName().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "真实姓名不能为空");
            return ResponseEntity.badRequest().body(response);
        }
        if (req.getIdNumber() == null || req.getIdNumber().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "身份证号不能为空");
            return ResponseEntity.badRequest().body(response);
        }
        if (req.getIdNumber().length() != 18) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "身份证号必须是18位");
            return ResponseEntity.badRequest().body(response);
        }
        if (req.getGender() == null || req.getGender().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "性别不能为空");
            return ResponseEntity.badRequest().body(response);
        }
        if (req.getContactInfo() == null || req.getContactInfo().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "联系方式不能为空");
            return ResponseEntity.badRequest().body(response);
        }

        String userType = req.getUserType() != null ? req.getUserType().trim() : "普通用户";
        String finalOfficerId = null;
        if ("管理员".equals(userType)) {
            String officerIdInput = req.getOfficerId();
            if (officerIdInput == null || officerIdInput.trim().isEmpty()) {
                Map<String, String> response = new HashMap<>();
                response.put("message", "管理员注册必须提供警号");
                return ResponseEntity.badRequest().body(response);
            }
            finalOfficerId = officerIdInput.trim();
            Optional<Officers> officerOpt = officersRepository.findById(finalOfficerId);
            if (!officerOpt.isPresent()) {
                Map<String, String> response = new HashMap<>();
                response.put("message", "警号不存在，请确认警号是否正确");
                return ResponseEntity.badRequest().body(response);
            }
            
            Officers officer = officerOpt.get();
            String idNumberCheck = req.getIdNumber();
            if (idNumberCheck != null) {
                idNumberCheck = idNumberCheck.trim().toUpperCase();
            }
            String officerIdNumber = officer.getIdNumber();
            if (idNumberCheck != null && officerIdNumber != null && !idNumberCheck.equals(officerIdNumber)) {
                Map<String, String> response = new HashMap<>();
                response.put("message", "警号对应的身份证号与您提供的身份证号不一致");
                return ResponseEntity.badRequest().body(response);
            }

            final String checkOfficerId = finalOfficerId;
            boolean officerAlreadyBound = userAccountsRepository.findAll().stream()
                .anyMatch(ua -> {
                    Officers uaOfficer = ua.getOfficer();
                    return uaOfficer != null && checkOfficerId.equals(uaOfficer.getOfficerId());
                });
            if (officerAlreadyBound) {
                Map<String, String> response = new HashMap<>();
                response.put("message", "该警号已被绑定到其他账户");
                return ResponseEntity.status(409).body(response);
            }
        }
        
        String idNumber = req.getIdNumber();
        if (idNumber != null && personsRepository.findById(idNumber).isPresent()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "该身份证号已被注册");
            return ResponseEntity.status(409).body(response);
        }

        if (idNumber != null) {
            idNumber = idNumber.trim().toUpperCase();
            req.setIdNumber(idNumber);
        }
        if (!isValidChineseId(idNumber)) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "身份证号格式或校验码不正确");
            return ResponseEntity.badRequest().body(response);
        }

        LocalDate providedBirthDate = null;
        String providedBirthDateStr = req.getBirthDate();
        if (providedBirthDateStr != null && !providedBirthDateStr.trim().isEmpty()) {
            try {
                providedBirthDate = LocalDate.parse(providedBirthDateStr.trim());
            } catch (DateTimeParseException e) {
                Map<String, String> response = new HashMap<>();
                response.put("message", "出生日期格式应为YYYY-MM-DD");
                return ResponseEntity.badRequest().body(response);
            }
        }
        
        try {
            UserAccounts account = new UserAccounts();
            account.setUsername(req.getUsername());
            account.setPasswordHash(req.getPassword());
            account.setUserType(userType);
            account.setRealName(req.getRealName());
            account.setIdNumber(idNumber);
            account.setCreatedAt(LocalDateTime.now());
            if ("管理员".equals(userType) && finalOfficerId != null) {
                Optional<Officers> officerOpt = officersRepository.findById(finalOfficerId);
                if (officerOpt.isPresent()) {
                    account.setOfficer(officerOpt.get());
                }
            }

            UserAccounts saved = userAccountsRepository.save(account);
            
            Persons person = new Persons();
            person.setIdNumber(idNumber);
            person.setName(req.getRealName());
            person.setGender(req.getGender());
            person.setBirthDate(providedBirthDate);
            person.setAddress(req.getAddress());
            person.setContactInfo(req.getContactInfo());
            personsRepository.save(person);

            Map<String, Object> response = new HashMap<>();
            response.put("userId", saved.getUserId());
            response.put("username", saved.getUsername());
            response.put("userType", saved.getUserType());
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, String> response = new HashMap<>();
            response.put("message", String.format("创建用户失败：%s", e.getMessage()));
            return ResponseEntity.status(500).body(response);
        }
    }

    @PostMapping("/verify-identity")
    public ResponseEntity<?> verifyIdentity(
            @RequestHeader(value = "Authorization", required = false) String auth,
            @RequestBody VerifyIdentityRequest req) {
        Integer userId = extractUserIdFromAuthHeader(auth);
        if (userId == null) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "未认证");
            return ResponseEntity.status(401).body(response);
        }
        
        Optional<UserAccounts> userOpt = userAccountsRepository.findById(userId);
        if (!userOpt.isPresent()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "用户不存在");
            return ResponseEntity.status(401).body(response);
        }
        
        UserAccounts user = userOpt.get();
        if (req.getIdNumber() == null || req.getIdNumber().trim().isEmpty() || 
            req.getRealName() == null || req.getRealName().trim().isEmpty()) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "身份证号和姓名不能为空");
            return ResponseEntity.badRequest().body(response);
        }
        
        if (req.getIdNumber().length() != 18) {
            Map<String, String> response = new HashMap<>();
            response.put("message", "身份证号格式不正确");
            return ResponseEntity.badRequest().body(response);
        }
        
        user.setIdNumber(req.getIdNumber());
        user.setRealName(req.getRealName());
        userAccountsRepository.save(user);
        
        Map<String, Object> response = new HashMap<>();
        response.put("message", "实名认证成功");
        response.put("idNumber", user.getIdNumber());
        response.put("realName", user.getRealName());
        return ResponseEntity.ok(response);
    }

    @GetMapping("/profile")
    public ResponseEntity<?> getProfile(@RequestHeader(value = "Authorization", required = false) String auth) {
        Integer userId = extractUserIdFromAuthHeader(auth);
        if (userId == null) {
            return ResponseEntity.status(401).body(Java17Compat.mapOf("message", "未认证"));
        }
        Optional<UserAccounts> userOpt = userAccountsRepository.findById(userId);
        if (userOpt.isEmpty()) {
            return ResponseEntity.status(404).body(Java17Compat.mapOf("message", "用户不存在"));
        }
        UserAccounts user = userOpt.get();
        Persons person = null;
        String profileIdNumber = user.getIdNumber();
        if (profileIdNumber != null) {
            person = personsRepository.findById(profileIdNumber).orElse(null);
        }
        Map<String, Object> response = new HashMap<>();
        response.put("username", user.getUsername());
        response.put("userType", user.getUserType());
        response.put("realName", user.getRealName());
        response.put("idNumber", user.getIdNumber());
        response.put("gender", person != null ? person.getGender() : null);
        response.put("birthDate", person != null && person.getBirthDate() != null ? person.getBirthDate().toString() : null);
        response.put("address", person != null ? person.getAddress() : null);
        response.put("contactInfo", person != null ? person.getContactInfo() : null);
        return ResponseEntity.ok(response);
    }

    @PutMapping("/profile")
    public ResponseEntity<?> updateProfile(
            @RequestHeader(value = "Authorization", required = false) String auth,
            @RequestBody UpdateProfileRequest req) {
        Integer userId = extractUserIdFromAuthHeader(auth);
        if (userId == null) {
            return ResponseEntity.status(401).body(Java17Compat.mapOf("message", "未认证"));
        }
        Optional<UserAccounts> userOpt = userAccountsRepository.findById(userId);
        if (userOpt.isEmpty()) {
            return ResponseEntity.status(404).body(Java17Compat.mapOf("message", "用户不存在"));
        }
        if (req.getRealName() == null || req.getRealName().trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "真实姓名不能为空"));
        }
        String requestedIdNumber = req.getIdNumber();
        if (requestedIdNumber == null || requestedIdNumber.trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "身份证号不能为空"));
        }
        final String normalizedIdNumber = requestedIdNumber.trim().toUpperCase();
        req.setIdNumber(normalizedIdNumber);
        if (!isValidChineseId(normalizedIdNumber)) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "身份证号格式或校验码不正确"));
        }
        if (req.getGender() == null || req.getGender().trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "请选择性别"));
        }
        if (req.getContactInfo() == null || req.getContactInfo().trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "联系方式不能为空"));
        }

        UserAccounts user = userOpt.get();
        String oldIdNumber = user.getIdNumber();
        if (oldIdNumber != null && !oldIdNumber.equals(normalizedIdNumber)) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "身份证号已实名认证，如需修改请联系管理员"));
        }
        if (user.getRealName() != null && !user.getRealName().trim().isEmpty()
                && !user.getRealName().equals(req.getRealName())) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "真实姓名已认证，如需修改请联系管理员"));
        }

        LocalDate birthDate = null;
        String birthDateStr = req.getBirthDate();
        if (birthDateStr != null && !birthDateStr.trim().isEmpty()) {
            try {
                birthDate = LocalDate.parse(birthDateStr.trim());
            } catch (DateTimeParseException e) {
                return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "出生日期格式应为YYYY-MM-DD"));
            }
        }

        user.setRealName(req.getRealName());
        user.setIdNumber(normalizedIdNumber);
        userAccountsRepository.save(user);

        Persons person = personsRepository.findById(Objects.requireNonNull(normalizedIdNumber)).orElse(null);
        if (person == null) {
            person = new Persons();
            person.setIdNumber(Objects.requireNonNull(normalizedIdNumber));
        }
        person.setName(req.getRealName());
        person.setGender(req.getGender());
        person.setBirthDate(birthDate);
        person.setAddress(req.getAddress());
        person.setContactInfo(req.getContactInfo());
        personsRepository.save(person);

        Map<String, Object> response = new HashMap<>();
        response.put("username", user.getUsername());
        response.put("userType", user.getUserType());
        response.put("realName", user.getRealName());
        response.put("idNumber", user.getIdNumber());
        response.put("gender", person.getGender());
        response.put("birthDate", birthDate != null ? birthDate.toString() : null);
        response.put("address", person.getAddress());
        response.put("contactInfo", person.getContactInfo());
        return ResponseEntity.ok(response);
    }

    @PutMapping("/password")
    public ResponseEntity<?> changePassword(
            @RequestHeader(value = "Authorization", required = false) String auth,
            @RequestBody ChangePasswordRequest req) {
        Integer userId = extractUserIdFromAuthHeader(auth);
        if (userId == null) {
            return ResponseEntity.status(401).body(Java17Compat.mapOf("message", "未认证"));
        }
        if (req.getOldPassword() == null || req.getOldPassword().trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "请输入当前密码"));
        }
        if (req.getNewPassword() == null || req.getNewPassword().trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "新密码不能为空"));
        }
        if (req.getNewPassword().trim().length() < 6) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "新密码长度至少为6位"));
        }
        Optional<UserAccounts> userOpt = userAccountsRepository.findById(userId);
        if (userOpt.isEmpty()) {
            return ResponseEntity.status(404).body(Java17Compat.mapOf("message", "用户不存在"));
        }
        UserAccounts user = userOpt.get();
        String storedPassword = user.getPasswordHash();
        if (storedPassword == null || !storedPassword.equals(req.getOldPassword())) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "当前密码不正确"));
        }
        if (req.getOldPassword().equals(req.getNewPassword())) {
            return ResponseEntity.badRequest().body(Java17Compat.mapOf("message", "新密码不能与当前密码相同"));
        }
        user.setPasswordHash(req.getNewPassword().trim());
        userAccountsRepository.save(user);
        return ResponseEntity.ok(Java17Compat.mapOf("message", "密码已更新"));
    }

    private Integer extractUserIdFromAuthHeader(String auth) {
        if (auth == null || !auth.startsWith("Bearer dummy-token-")) {
            return null;
        }
        try {
            String idStr = auth.substring("Bearer dummy-token-".length());
            return Integer.parseInt(idStr);
        } catch (Exception e) {
            return null;
        }
    }

    private static final Pattern CHINA_ID_PATTERN =
            Pattern.compile("^[1-9]\\d{5}(19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[\\dXx]$");

    private boolean isValidChineseId(String idNumber) {
        if (idNumber == null) {
            return false;
        }
        String upper = idNumber.trim().toUpperCase();
        if (!CHINA_ID_PATTERN.matcher(upper).matches()) {
            return false;
        }
        int[] weight = {7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2};
        char[] checkCode = {'1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'};
        int sum = 0;
        for (int i = 0; i < 17; i++) {
            sum += (upper.charAt(i) - '0') * weight[i];
        }
        char expected = checkCode[sum % 11];
        return expected == upper.charAt(17);
    }

}


