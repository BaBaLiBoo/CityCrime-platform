<template>
  <div v-if="loading">正在加载案件详情...</div>
  <div v-else-if="caseDetail" class="page-container">
    <div class="header-bar">
      <h1>案件详情</h1>
      <div class="actions">
        <el-button @click="refresh">刷新</el-button>
      </div>
    </div>

    <el-card class="mb16">
      <el-descriptions :column="2" border>
        <el-descriptions-item label="案件ID">{{ caseDetail.caseId }}</el-descriptions-item>
        <el-descriptions-item label="案件标题">{{ caseDetail.caseTitle }}</el-descriptions-item>
        <el-descriptions-item label="案件类型">{{ caseDetail.caseType }}</el-descriptions-item>
        <el-descriptions-item label="状态">{{ caseDetail.status }}</el-descriptions-item>
        <el-descriptions-item label="报案时间">{{ formatDateTime(caseDetail.reportTime) }}</el-descriptions-item>
        <el-descriptions-item label="立案时间">{{ caseDetail.filingTime ? formatDateTime(caseDetail.filingTime) : '—' }}</el-descriptions-item>
        <el-descriptions-item label="侦破时间">{{ caseDetail.solveTime ? formatDateTime(caseDetail.solveTime) : '—' }}</el-descriptions-item>
        <el-descriptions-item label="归档时间">{{ caseDetail.archiveTime ? formatDateTime(caseDetail.archiveTime) : '—' }}</el-descriptions-item>
        <el-descriptions-item label="案发地点">{{ caseDetail.location?.address || 'N/A' }}</el-descriptions-item>
        <el-descriptions-item label="案件描述" :span="2">{{ caseDetail.description || '—' }}</el-descriptions-item>
      </el-descriptions>
    </el-card>

    <!-- 案件状态时间轴 -->
    <el-card class="mb16">
      <CaseTimeline :case-data="caseDetail" />
    </el-card>

    <!-- 多媒体文件（管理员查看） -->
    <el-card v-if="mediaFiles && mediaFiles.length > 0" class="mb16">
      <template #header>
        <span>多媒体文件</span>
      </template>
      <div class="media-files">
        <div v-for="(file, index) in mediaFiles" :key="index" class="media-item">
          <img v-if="isImage(file)" :src="getFileUrl(file)" alt="图片" class="media-image" />
          <a v-else :href="getFileUrl(file)" target="_blank" class="media-link">{{ file }}</a>
        </div>
      </div>
    </el-card>

    <el-row :gutter="16">
      <el-col :span="12">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>办案警员</span>
              <el-button size="small" type="primary" @click="openAddOfficer">关联警员</el-button>
            </div>
          </template>
          <el-table :data="officers" size="small">
            <el-table-column prop="officerId" label="警员编号" width="140" />
            <el-table-column prop="personDetails.name" label="姓名" />
            <el-table-column prop="department" label="部门" />
            <el-table-column prop="position" label="职位" />
            <el-table-column label="操作" width="80">
              <template #default="{ row }">
                <el-button size="small" type="danger" @click="removeOfficer(row)">移除</el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>涉案人员</span>
              <el-button size="small" type="primary" @click="openAddCasePerson">关联涉案人员</el-button>
            </div>
          </template>
          <el-table :data="casePersons" size="small">
            <el-table-column prop="name" label="姓名" />
            <el-table-column prop="idNumber" label="身份证号" />
            <el-table-column prop="roleInCase" label="角色" width="120" />
            <el-table-column label="操作" width="80">
              <template #default="{ row }">
                <el-button size="small" type="danger" @click="removePerson(row)">移除</el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-card>
      </el-col>
    </el-row>

    <!-- 关联警员弹窗 -->
    <el-dialog v-model="addOfficerVisible" title="关联警员" width="600px">
      <el-form :model="addOfficerForm" label-width="120px">
        <el-form-item label="选择警员" prop="officerId" required>
          <el-select v-model="addOfficerForm.officerId" filterable placeholder="请选择或搜索警员">
            <el-option 
              v-for="officer in allOfficers" 
              :key="officer.officerId" 
              :label="`${officer.personDetails.name}（${officer.officerId}）`" 
              :value="officer.officerId" 
            />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="addOfficerVisible = false">取消</el-button>
        <el-button type="primary" :loading="submitting" @click="submitAddOfficer">确定</el-button>
      </template>
    </el-dialog>

    <!-- 关联涉案人员弹窗 -->
    <el-dialog v-model="addCasePersonVisible" title="关联涉案人员" width="520px">
      <el-form :model="addCasePersonForm" label-width="120px">
        <el-form-item label="选择人员" prop="idNumber" required>
          <el-select v-model="addCasePersonForm.idNumber" filterable placeholder="请选择或搜索人员">
            <el-option 
              v-for="p in allPersons" 
              :key="p.idNumber" 
              :label="`${p.name}（${p.idNumber}）`" 
              :value="p.idNumber" 
            />
          </el-select>
        </el-form-item>
        <el-form-item label="角色" prop="roleInCase" required>
          <el-select v-model="addCasePersonForm.roleInCase" placeholder="请选择角色">
            <el-option label="嫌疑人" value="嫌疑人" />
            <el-option label="受害人" value="受害人" />
            <el-option label="证人" value="证人" />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="addCasePersonVisible = false">取消</el-button>
        <el-button type="primary" :loading="submitting" @click="submitAddCasePerson">确定</el-button>
      </template>
    </el-dialog>
  </div>
  <div v-else>未找到指定的案件信息。</div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useRoute } from 'vue-router';
import caseApi from '@/api/case.js';
import personApi from '@/api/person.js';
import * as officerApi from '@/api/officer.js';
import { ElMessage, ElMessageBox } from 'element-plus';
import CaseTimeline from '@/components/CaseTimeline.vue';

const route = useRoute();
const caseId = computed(() => route.params.id);
const caseDetail = ref(null);
const officers = ref([]);
const casePersons = ref([]);
const allPersons = ref([]);
const allOfficers = ref([]);
const loading = ref(true);
const submitting = ref(false);

const addOfficerVisible = ref(false);
const addOfficerForm = ref({ officerId: '' });

const addCasePersonVisible = ref(false);
const addCasePersonForm = ref({ idNumber: '', roleInCase: '' });

const mediaFiles = computed(() => {
  if (!caseDetail.value?.mediaFiles) return [];
  const raw = caseDetail.value.mediaFiles;
  try {
    if (typeof raw === 'string' && raw.trim().startsWith('[')) {
      return JSON.parse(raw);
    }
    if (typeof raw === 'string' && raw.includes(',')) {
      return raw.split(',').map(s => s.trim()).filter(Boolean);
    }
    return Array.isArray(raw) ? raw : [raw];
  } catch (e) {
    return [];
  }
});

const refresh = async () => {
  try {
    loading.value = true;
    const res = await caseApi.getCaseById(caseId.value);
    caseDetail.value = res.data;
    officers.value = Array.from(res.data.officers || []);
    casePersons.value = Array.from(res.data.involvedPersons || []);
  } catch (e) {
    console.error('获取案件详情失败:', e);
    const errorMessage = e.response?.data?.message || '获取案件详情失败';
    ElMessage.error(errorMessage);
  } finally {
    loading.value = false;
  }
};

const loadAllPersons = async () => {
  try {
    const res = await personApi.getAllPersons();
    allPersons.value = res.data || [];
  } catch (e) {
    // ignore toast here
  }
};

const loadAllOfficers = async () => {
  try {
    const res = await officerApi.getAllOfficers();
    allOfficers.value = res.data || [];
  } catch (e) {
    // ignore toast here
  }
};

onMounted(async () => {
  await Promise.all([refresh(), loadAllPersons(), loadAllOfficers()]);
});

const openAddOfficer = () => {
  addOfficerForm.value.officerId = '';
  addOfficerVisible.value = true;
};

const submitAddOfficer = async () => {
  if (!addOfficerForm.value.officerId) {
    ElMessage.warning('请输入警员编号');
    return;
  }
  submitting.value = true;
  try {
    await caseApi.addOfficerToCase(caseId.value, addOfficerForm.value.officerId);
    ElMessage.success('关联成功');
    addOfficerVisible.value = false;
    await refresh();
  } catch (e) {
    ElMessage.error('关联失败');
  } finally {
    submitting.value = false;
  }
};

const openAddCasePerson = () => {
  addCasePersonForm.value = { idNumber: '', roleInCase: '' };
  addCasePersonVisible.value = true;
};

const submitAddCasePerson = async () => {
  const { idNumber, roleInCase } = addCasePersonForm.value;
  if (!idNumber || !roleInCase) {
    ElMessage.warning('请选择人员并选择角色');
    return;
  }
  submitting.value = true;
  try {
    await caseApi.addPersonToCase(caseId.value, { idNumber, roleInCase });
    ElMessage.success('关联成功');
    addCasePersonVisible.value = false;
    await refresh();
  } catch (e) {
    console.error('关联涉案人员失败:', e);
    const errorMessage = e.response?.data?.message || '关联失败';
    ElMessage.error(errorMessage);
  } finally {
    submitting.value = false;
  }
};

// 删除警员
const removeOfficer = async (officer) => {
  try {
    await ElMessageBox.confirm(`确定要移除警员 ${officer.personDetails.name} 吗？`, '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    });
    
    await caseApi.removeOfficerFromCase(caseId.value, officer.officerId);
    ElMessage.success('移除成功');
    await refresh();
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('移除失败');
    }
  }
};

// 删除涉案人员
const removePerson = async (person) => {
  try {
    await ElMessageBox.confirm(`确定要移除涉案人员 ${person.name} 吗？`, '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    });
    
    await caseApi.removePersonFromCase(caseId.value, person.idNumber);
    ElMessage.success('移除成功');
    await refresh();
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('移除失败');
    }
  }
};

// 格式化日期时间
const formatDateTime = (dateTime) => {
  console.log('CaseDetailView formatDateTime 输入:', dateTime, '类型:', typeof dateTime);
  
  if (!dateTime) {
    console.log('时间为空，返回空字符串');
    return '';
  }
  
  try {
    let date;
    
    // 处理不同的时间格式
    if (typeof dateTime === 'string') {
      console.log('处理字符串时间:', dateTime);
      
      // 如果是字符串，尝试解析
      if (dateTime.includes('T')) {
        // ISO 格式：2024-01-15T10:30:00
        console.log('检测到ISO格式');
        date = new Date(dateTime);
      } else if (dateTime.includes(' ')) {
        // 空格格式：2024-01-15 10:30:00
        console.log('检测到空格格式，转换为ISO格式');
        date = new Date(dateTime.replace(' ', 'T'));
      } else {
        // 其他格式直接尝试解析
        console.log('尝试直接解析');
        date = new Date(dateTime);
      }
    } else if (dateTime instanceof Date) {
      console.log('处理Date对象');
      date = dateTime;
    } else {
      // 其他类型尝试转换
      console.log('处理其他类型:', typeof dateTime);
      date = new Date(dateTime);
    }
    
    console.log('解析后的Date对象:', date);
    
    // 检查日期是否有效
    if (isNaN(date.getTime())) {
      console.warn('无效的日期时间:', dateTime);
      return '时间格式错误';
    }
    
    const formatted = date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    
    console.log('格式化结果:', formatted);
    return formatted;
  } catch (error) {
    console.error('日期格式化错误:', error, '原始值:', dateTime);
    return '时间格式错误';
  }
};

const isImage = (filename) => {
  const imageExts = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
  return typeof filename === 'string' && imageExts.some(ext => filename.toLowerCase().endsWith(ext));
};

const getFileUrl = (filename) => {
  if (!filename) return '';
  if (filename.startsWith('/uploads/')) {
    return `http://localhost:8080${filename}`;
  }
  return `http://localhost:8080/uploads/${filename}`;
};
</script>

<style scoped>
.page-container { display: flex; flex-direction: column; }
.header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.mb16 { margin-bottom: 16px; }
.card-header { display: flex; justify-content: space-between; align-items: center; }
.media-files { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 8px; }
.media-item { flex: 0 0 auto; }
.media-image { max-width: 300px; max-height: 300px; border-radius: 4px; cursor: pointer; }
.media-link { display: block; padding: 8px 16px; background: #f5f7fa; border-radius: 4px; text-decoration: none; color: #409eff; }
</style>