package com.example.crimeplatformapi.service;

import com.example.crimeplatformapi.dto.CreateCaseRequest;
import com.example.crimeplatformapi.entity.*;
import com.example.crimeplatformapi.exception.ResourceNotFoundException;
import com.example.crimeplatformapi.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class CaseService {

    @Autowired
    private CasesRepository casesRepository;

    @Autowired
    private LocationsRepository locationsRepository;

    @Autowired
    private OfficersRepository officersRepository;

    @Autowired
    private PersonsRepository personsRepository;

    @Autowired
    private CasePersonsRepository casePersonsRepository;

    public List<Cases> findAllCases() {
        return casesRepository.findAllWithLocation();
    }

    public Cases findCaseById(Integer caseId) {
        Cases caseEntity = casesRepository.findByIdWithLocation(caseId);
        if (caseEntity == null) {
            throw new ResourceNotFoundException("未找到ID为 " + caseId + " 的案件");
        }
        return caseEntity;
    }

    @Transactional
    public Cases createCase(CreateCaseRequest request) {
        Locations newLocation = new Locations();
        newLocation.setAddress(request.locationAddress());
        newLocation.setDistrict(request.district());
        Locations savedLocation = locationsRepository.save(newLocation);

        Cases newCase = new Cases();
        newCase.setCaseTitle(request.caseTitle());
        newCase.setCaseType(request.caseType());
        newCase.setStatus(request.status());
        newCase.setReportTime(request.reportTime());
        newCase.setFilingTime(request.filingTime());
        newCase.setSolveTime(request.solveTime());
        newCase.setArchiveTime(request.archiveTime());
        newCase.setDescription(request.description());
        newCase.setSource(request.source() != null ? request.source() : "其他");
        newCase.setLocation(savedLocation); 

        return casesRepository.save(newCase);
    }

    @Transactional
    public Cases updateCase(Integer caseId, CreateCaseRequest request) {
        Cases existingCase = findCaseById(caseId);

        if (existingCase.getLocation() != null) {
            existingCase.getLocation().setAddress(request.locationAddress());
            existingCase.getLocation().setDistrict(request.district());
            locationsRepository.save(existingCase.getLocation());
        } else {
            Locations newLocation = new Locations();
            newLocation.setAddress(request.locationAddress());
            newLocation.setDistrict(request.district());
            Locations savedLocation = locationsRepository.save(newLocation);
            existingCase.setLocation(savedLocation);
        }

        existingCase.setCaseTitle(request.caseTitle());
        existingCase.setCaseType(request.caseType());
        existingCase.setStatus(request.status());
        existingCase.setReportTime(request.reportTime());
        existingCase.setFilingTime(request.filingTime());
        existingCase.setSolveTime(request.solveTime());
        existingCase.setArchiveTime(request.archiveTime());
        existingCase.setDescription(request.description());
        existingCase.setSource(request.source() != null ? request.source() : existingCase.getSource());
        normalizeTimelineByStatus(existingCase);

        return casesRepository.save(existingCase);
    }

    private void normalizeTimelineByStatus(Cases existingCase) {
        String currentStatus = existingCase.getStatus();
        if (currentStatus == null) {
            return;
        }
        switch (currentStatus) {
            case "已接报" -> {
                existingCase.setFilingTime(null);
                existingCase.setSolveTime(null);
                existingCase.setArchiveTime(null);
            }
            case "立案侦查" -> {
                existingCase.setSolveTime(null);
                existingCase.setArchiveTime(null);
            }
            case "已告破" -> existingCase.setArchiveTime(null);
            default -> {
            }
        }
    }

    @Transactional
    public void deleteCase(Integer caseId) {
        if (!casesRepository.existsById(caseId)) {
            throw new ResourceNotFoundException("删除案件失败：未找到ID为 " + caseId + " 的案件");
        }
        casesRepository.deleteById(caseId);
    }

    @Transactional
    public Cases addOfficerToCase(Integer caseId, String officerId) {
        Cases currentCase = findCaseById(caseId);
        Officers officer = officersRepository.findById(officerId)
                .orElseThrow(() -> new ResourceNotFoundException("关联警员失败：未找到ID为 " + officerId + " 的警员"));
        currentCase.getOfficers().add(officer);
        return casesRepository.save(currentCase);
    }

    @Transactional
    public Cases addPersonToCase(Integer caseId, String idNumber, String roleInCase) {
        Cases currentCase = findCaseById(caseId);
        Persons person = personsRepository.findById(idNumber)
                .orElseThrow(() -> new ResourceNotFoundException("关联涉案人员失败：未找到身份证号为 " + idNumber + " 的人员"));

            CasePersonsId casePersonsId = new CasePersonsId();
            casePersonsId.setCaseId(caseId);
            casePersonsId.setIdNumber(idNumber);
            casePersonsId.setRoleInCase(roleInCase);

            CasePersons casePerson = new CasePersons();
            casePerson.setId(casePersonsId);
            casePerson.setCases(currentCase);
            casePerson.setPerson(person);

        casePersonsRepository.save(casePerson);
        return currentCase;
    }
    
    @Transactional
    public Cases removeOfficerFromCase(Integer caseId, String officerId) {
        Cases currentCase = findCaseById(caseId);
        Officers officer = officersRepository.findById(officerId)
                .orElseThrow(() -> new ResourceNotFoundException("移除警员失败：未找到ID为 " + officerId + " 的警员"));
        currentCase.getOfficers().remove(officer);
        return casesRepository.save(currentCase);
    }
    
    @Transactional
    public Cases removePersonFromCase(Integer caseId, String idNumber) {
        Cases currentCase = findCaseById(caseId);
        personsRepository.findById(idNumber)
                .orElseThrow(() -> new ResourceNotFoundException("移除涉案人员失败：未找到身份证号为 " + idNumber + " 的人员"));
        
        List<CasePersons> casePersonsToDelete = casePersonsRepository.findAll().stream()
                .filter(cp -> cp.getId().getCaseId().equals(caseId) && cp.getId().getIdNumber().equals(idNumber))
                .collect(Collectors.toList());
        
        casePersonsRepository.deleteAll(casePersonsToDelete);
        return currentCase;
    }
}