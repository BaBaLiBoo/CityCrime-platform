package com.example.crimeplatformapi.controller;

import com.example.crimeplatformapi.dto.*;
import com.example.crimeplatformapi.entity.Cases;
import com.example.crimeplatformapi.service.CaseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import com.example.crimeplatformapi.util.Java17Compat;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.Set;
import java.util.HashSet;

@RestController
@RequestMapping("/api/cases")

public class CaseController {

    @Autowired
    private CaseService caseService;

    @GetMapping
    public List<CaseDTO> getAllCases() {
        return caseService.findAllCases().stream()
                .map(this::convertToCaseDTO)
                .collect(Collectors.toList());
    }

    @GetMapping("/{id}")
    public ResponseEntity<CaseDetailDTO> getCaseById(@PathVariable Integer id) {
        Cases caseEntity = caseService.findCaseById(id);
        return ResponseEntity.ok(convertToCaseDetailDTO(caseEntity));
    }

    @PostMapping
    public ResponseEntity<?> createCase(@RequestBody CreateCaseRequest request) {
        try {
            Cases createdCase = caseService.createCase(request);
            return new ResponseEntity<>(convertToCaseDTO(createdCase), HttpStatus.CREATED);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(Java17Compat.mapOf("message", String.format("创建案件失败: %s", e.getMessage())));
        }
    }

    @PutMapping("/{id}")
    public ResponseEntity<CaseDTO> updateCase(@PathVariable Integer id, @RequestBody CreateCaseRequest request) {
        Cases updatedCase = caseService.updateCase(id, request);
        return ResponseEntity.ok(convertToCaseDTO(updatedCase));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteCase(@PathVariable Integer id) {
        caseService.deleteCase(id);
        return ResponseEntity.noContent().build(); // 返回 204 No Content
    }

    @PostMapping("/{caseId}/officers/{officerId}")
    public ResponseEntity<CaseDetailDTO> addOfficerToCase(@PathVariable Integer caseId, @PathVariable String officerId) {
        Cases updatedCase = caseService.addOfficerToCase(caseId, officerId);
        return ResponseEntity.ok(convertToCaseDetailDTO(updatedCase));
    }
    
    @PostMapping("/{caseId}/persons")
    public ResponseEntity<CaseDetailDTO> addPersonToCase(@PathVariable Integer caseId, @RequestBody AddPersonRequest request) {
        caseService.addPersonToCase(caseId, request.idNumber(), request.roleInCase());
        Cases updatedCase = caseService.findCaseById(caseId);
        return ResponseEntity.ok(convertToCaseDetailDTO(updatedCase));
    }
    
    @DeleteMapping("/{caseId}/officers/{officerId}")
    public ResponseEntity<CaseDetailDTO> removeOfficerFromCase(@PathVariable Integer caseId, @PathVariable String officerId) {
        Cases updatedCase = caseService.removeOfficerFromCase(caseId, officerId);
        return ResponseEntity.ok(convertToCaseDetailDTO(updatedCase));
    }
    
    @DeleteMapping("/{caseId}/persons/{idNumber}")
    public ResponseEntity<CaseDetailDTO> removePersonFromCase(@PathVariable Integer caseId, @PathVariable String idNumber) {
        Cases updatedCase = caseService.removePersonFromCase(caseId, idNumber);
        return ResponseEntity.ok(convertToCaseDetailDTO(updatedCase));
    }


    private CaseDTO convertToCaseDTO(Cases entity) {
        String address = (entity.getLocation() != null) ? entity.getLocation().getAddress() : "无地点信息";
        String district = (entity.getLocation() != null) ? entity.getLocation().getDistrict() : null;
        return new CaseDTO(
                entity.getCaseId(),
                entity.getCaseTitle(),
                entity.getCaseType(),
                entity.getStatus(),
                entity.getReportTime(),
                entity.getFilingTime(),
                entity.getSolveTime(),
                entity.getArchiveTime(),
                address,
                district,
                entity.getSource() != null ? entity.getSource() : "其他"
        );
    }

    private CaseDetailDTO convertToCaseDetailDTO(Cases entity) {
        // 转换地点信息
        LocationDTO locationDTO = null;
        if (entity.getLocation() != null) {
            locationDTO = new LocationDTO(
                    entity.getLocation().getLocationId(),
                    entity.getLocation().getAddress(),
                    entity.getLocation().getDistrict(),
                    entity.getLocation().getLongitude(),
                    entity.getLocation().getLatitude()
            );
        }

        // 转换办案警员信息
        Set<OfficerDTO> officerDTOs = new HashSet<>();
        if (entity.getOfficers() != null && !entity.getOfficers().isEmpty()) {
            officerDTOs = entity.getOfficers().stream().map(officer -> new OfficerDTO(
                    officer.getOfficerId(),
                    officer.getDepartment(),
                    officer.getPosition(),
                    new PersonDTO( // 嵌套警员的基础信息
                            officer.getIdNumber(),
                            officer.getName(),
                            officer.getGender(),
                            officer.getBirthDate(),
                            officer.getAddress(),
                            officer.getContactInfo()
                    )
            )).collect(Collectors.toSet());
        }

        // 转换涉案人员信息
        Set<CasePersonDTO> casePersonDTOs = new HashSet<>();
        if (entity.getCasePersons() != null && !entity.getCasePersons().isEmpty()) {
            casePersonDTOs = entity.getCasePersons().stream().map(casePerson -> new CasePersonDTO(
                    casePerson.getPerson().getIdNumber(),
                    casePerson.getPerson().getName(),
                    casePerson.getId().getRoleInCase()
            )).collect(Collectors.toSet());
        }


        return new CaseDetailDTO(
                entity.getCaseId(),
                entity.getCaseTitle(),
                entity.getCaseType(),
                entity.getStatus(),
                entity.getReportTime(),
                entity.getFilingTime(),
                entity.getSolveTime(),
                entity.getArchiveTime(),
                entity.getDescription(),
                entity.getSource() != null ? entity.getSource() : "其他",
                entity.getMediaFiles(),
                locationDTO,
                officerDTOs,
                casePersonDTOs
        );
    }
}