<template>
  <div class="page-container">
    <div class="header-bar">
      <h1>{{ pageTitle }}</h1>
    </div>
    <el-card>
      <el-form :model="form" ref="formRef" label-width="120px">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="案件标题" prop="caseTitle" required>
              <el-input v-model="form.caseTitle" placeholder="请输入案件标题" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="案件类型" prop="caseType" required>
              <el-select v-model="form.caseType" placeholder="请选择类型" style="width: 100%;">
                <el-option v-for="t in CASE_TYPES" :key="t" :label="t" :value="t" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="案件状态" prop="status" required>
              <el-select v-model="form.status" placeholder="请选择状态" style="width: 100%;">
                <el-option label="已接报" value="已接报" />
                <el-option label="立案侦查" value="立案侦查" />
                <el-option label="已告破" value="已告破" />
                <el-option label="已归档" value="已归档" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="报案时间" prop="reportTime" required>
              <el-date-picker
                v-model="form.reportTime"
                type="datetime"
                placeholder="选择报案时间"
                format="YYYY-MM-DD HH:mm:ss"
                value-format="YYYY-MM-DD HH:mm:ss"
                style="width: 100%;"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12" v-if="form.status === '立案侦查' || form.status === '已告破' || form.status === '已归档'">
            <el-form-item label="立案时间" prop="filingTime">
              <el-date-picker
                v-model="form.filingTime"
                type="datetime"
                placeholder="选择立案时间"
                format="YYYY-MM-DD HH:mm:ss"
                value-format="YYYY-MM-DD HH:mm:ss"
                style="width: 100%;"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12" v-if="form.status === '已告破' || form.status === '已归档'">
            <el-form-item label="侦破时间" prop="solveTime">
              <el-date-picker
                v-model="form.solveTime"
                type="datetime"
                placeholder="选择侦破时间"
                format="YYYY-MM-DD HH:mm:ss"
                value-format="YYYY-MM-DD HH:mm:ss"
                style="width: 100%;"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12" v-if="form.status === '已归档'">
            <el-form-item label="归档时间" prop="archiveTime">
              <el-date-picker
                v-model="form.archiveTime"
                type="datetime"
                placeholder="选择归档时间"
                format="YYYY-MM-DD HH:mm:ss"
                value-format="YYYY-MM-DD HH:mm:ss"
                style="width: 100%;"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="行政区" prop="district" required>
              <el-select v-model="form.district" placeholder="请选择行政区" style="width: 100%;">
                <el-option v-for="district in SHANGHAI_DISTRICTS" :key="district" :label="district" :value="district" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="详细地址" prop="address" required>
              <el-input v-model="form.address" placeholder="请输入详细地址" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="案件来源" prop="source" required>
              <el-select v-model="form.source" placeholder="请选择案件来源" style="width: 100%;">
                <el-option label="在线举报" value="在线举报" />
                <el-option label="导入案件" value="导入案件" />
                <el-option label="电话报警" value="电话报警" />
                <el-option label="线下报警" value="线下报警" />
                <el-option label="短信报警" value="短信报警" />
                <el-option label="其他" value="其他" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="24">
            <el-form-item label="案件描述" prop="description">
              <el-input
                v-model="form.description"
                type="textarea"
                :rows="4"
                placeholder="请输入案件详细描述"
              />
            </el-form-item>
          </el-col>
        </el-row>
        <el-form-item>
          <el-button type="primary" @click="onSubmit" :loading="isSubmitting">保存</el-button>
          <el-button @click="onCancel">取消</el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import caseApi from '@/api/case.js';
import { ElMessage } from 'element-plus';

const route = useRoute();
const router = useRouter();
const formRef = ref(null);
const form = ref({
  caseTitle: '',
  caseType: '',
  status: '已接报',
  reportTime: '',
  filingTime: '',
  solveTime: '',
  archiveTime: '',
  district: '',
  address: '',
  description: '',
  source: '其他'
});
const isSubmitting = ref(false);
const loading = ref(false);

const isEditMode = computed(() => route.params.id);
const isAdmin = computed(() => localStorage.getItem('user_type') === '管理员');
const pageTitle = computed(() => {
  if (isEditMode.value) {
    return isAdmin.value ? '更新案件状态' : '编辑案件';
  }
  return '创建案件';
});

console.log('路由参数:', route.params);
console.log('编辑模式:', isEditMode.value);

const SHANGHAI_DISTRICTS = [
  '黄浦区', '徐汇区', '长宁区', '静安区', '普陀区', '虹口区', '杨浦区',
  '闵行区', '宝山区', '嘉定区', '浦东新区', '金山区', '松江区', '青浦区',
  '奉贤区', '崇明区'
];

const CASE_TYPES = ['盗窃', '抢劫', '诈骗', '伤害', '其他'];

const formatDateTime = (dateTime) => {
  if (!dateTime) return null;
  
  try {
    if (typeof dateTime === 'string') {
      if (dateTime.includes('T')) {
        return dateTime;
      } else {
        return dateTime.replace(' ', 'T');
      }
    } else if (dateTime instanceof Date) {
      return dateTime.toISOString();
    }
    
    return dateTime;
  } catch (error) {
    console.error('日期时间格式化错误:', error);
    return null;
  }
};

const loadCaseData = async () => {
  if (!isEditMode.value) return;
  
  loading.value = true;
  try {
    const response = await caseApi.getCaseById(route.params.id);
    const caseData = response.data;
    
    form.value.caseTitle = caseData.caseTitle;
    form.value.caseType = caseData.caseType;
    form.value.status = caseData.status;
    form.value.reportTime = caseData.reportTime;
    form.value.filingTime = caseData.filingTime || '';
    form.value.solveTime = caseData.solveTime || '';
    form.value.archiveTime = caseData.archiveTime || '';
    form.value.description = caseData.description || '';
    
    form.value.address = caseData.location?.address || '';
    form.value.district = caseData.location?.district || '';
    
    form.value.source = caseData.source || '其他';
  } catch (error) {
    console.error('加载案件数据失败:', error);
    ElMessage.error('加载案件数据失败');
    router.push('/cases');
  } finally {
    loading.value = false;
  }
};

const onSubmit = async () => {
  if (!formRef.value) return;
  await formRef.value.validate(async (valid) => {
    if (!valid) return;
    isSubmitting.value = true;
    try {
      const caseData = {
        caseTitle: form.value.caseTitle,
        caseType: form.value.caseType,
        status: form.value.status,
        reportTime: formatDateTime(form.value.reportTime),
        filingTime: formatDateTime(form.value.filingTime),
        solveTime: formatDateTime(form.value.solveTime),
        archiveTime: formatDateTime(form.value.archiveTime),
        description: form.value.description,
        locationAddress: form.value.address,
        district: form.value.district,
        source: form.value.source || '其他'
      };
      
      console.log('发送的案件数据:', caseData);
      console.log('当前模式:', isEditMode.value ? '编辑' : '创建');
      console.log('案件ID:', route.params.id);
      console.log('原始日期时间:', form.value.reportTime);
      console.log('格式化后日期时间:', formatDateTime(form.value.reportTime));
      
      if (isEditMode.value) {
        console.log('调用更新API，案件ID:', route.params.id);
        await caseApi.updateCase(route.params.id, caseData);
        ElMessage.success('案件更新成功！');
      } else {
        console.log('调用创建API');
        await caseApi.createCase(caseData);
        ElMessage.success('案件创建成功！');
      }
      
      router.push('/cases');
    } catch (error) {
      console.error('案件操作失败:', error);
      console.error('错误详情:', {
        status: error.response?.status,
        statusText: error.response?.statusText,
        data: error.response?.data,
        message: error.message
      });
      
      let errorMessage = '保存失败，请重试！';
      if (error.response?.status === 400) {
        errorMessage = '请求数据格式错误，请检查输入信息';
      } else if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      ElMessage.error(errorMessage);
    } finally {
      isSubmitting.value = false;
    }
  });
};

const onCancel = () => {
  router.push('/cases');
};

onMounted(() => {
  loadCaseData();
});
</script>

<style scoped>
.page-container {
  max-width: 1400px;
  margin: 0 auto;
}
.header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.header-bar h1 {
  font-size: 22px;
  margin: 0;
}
</style>