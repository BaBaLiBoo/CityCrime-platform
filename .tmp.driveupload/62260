import { createRouter, createWebHistory } from 'vue-router'
import { ElMessage } from 'element-plus'
import CaseListView from '../views/CaseListView.vue'
import DashboardView from '../views/DashboardView.vue'
import HomeView from '../views/HomeView.vue'
import PersonListView from '../views/PersonListView.vue';
import LocationListView from '../views/LocationListView.vue';
import OfficerListView from '../views/OfficerListView.vue';
const LoginView = () => import('../views/LoginView.vue');
const RegisterView = () => import('../views/RegisterView.vue');
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      // 路由重定向：当用户访问根路径'/'时，自动跳转到首页
      path: '/',
      redirect: '/home'
    },
    { path: '/login', name: 'Login', component: LoginView },
    { path: '/register', name: 'Register', component: RegisterView },
    {
      path: '/home',
      name: 'Home',
      component: HomeView
    },
    {
      path: '/dashboard',
      name: 'Dashboard',
      component: DashboardView
    },
    {
      path: '/cases',
      name: 'CaseList',
      component: CaseListView
    },
    {
      path: '/cases/create',
      name: 'CaseCreate',
      // 使用路由懒加载
      component: () => import('../views/CaseForm.vue')
    },
    {
      path: '/cases/edit/:id',
      name: 'CaseEdit',
      component: () => import('../views/CaseForm.vue'),
      props: true
    },
    {
      path: '/cases/:id',
      name: 'CaseDetail',
      component: () => import('../views/CaseDetailView.vue'),
      props: true
    },
    {
      path: '/persons',
      name: 'PersonList',
      component: PersonListView
    },
    {
      path: '/persons/create',
      name: 'PersonCreate',
      component: () => import('../views/PersonForm.vue')
    },
    {
      path: '/persons/edit/:id',
      name: 'PersonEdit',
      component: () => import('../views/PersonForm.vue'),
      props: true
    }
    ,
    {
      path: '/locations',
      name: 'LocationList',
      component: LocationListView
    },
    {
      path: '/locations/create',
      name: 'LocationCreate',
      component: () => import('../views/LocationForm.vue')
    },
    {
      path: '/officers',
      name: 'OfficerList',
      component: OfficerListView
    },
    {
      path: '/user/home',
      name: 'UserHome',
      component: () => import('../views/UserHomeView.vue')
    },
    {
      path: '/user/report',
      name: 'UserReport',
      component: () => import('../views/UserReportView.vue')
    },
    {
      path: '/user/my-reports',
      name: 'MyReports',
      component: () => import('../views/UserHomeView.vue')
    },
    {
      path: '/user/cases/:id',
      name: 'UserCaseDetail',
      component: () => import('../views/UserCaseDetailView.vue')
    },
    {
      path: '/user/cases/:id/edit',
      name: 'UserCaseEdit',
      component: () => import('../views/UserCaseEditView.vue')
    },
    {
      path: '/user/profile',
      name: 'UserProfile',
      component: () => import('../views/UserProfileView.vue')
    }
  ]
})

// 路由守卫：登录态校验和权限控制
router.beforeEach(async (to, from, next) => {
  const publicPages = ['/login', '/register'];
  const authRequired = !publicPages.includes(to.path);
  const token = localStorage.getItem('auth_token');
  let userType = localStorage.getItem('user_type');
  
  // 如果是公开页面，直接放行
  if (!authRequired) {
    return next();
  }
  
  // 如果没有token，跳转到登录页
  if (!token) {
    return next('/login');
  }
  
  // 验证token并获取最新的用户类型
  try {
    const apiClient = (await import('../api/index.js')).default;
    const response = await apiClient.get('/auth/me');
    userType = response.data.userType || '普通用户';
    localStorage.setItem('user_type', userType);
  } catch (error) {
    // token无效，清除并跳转到登录页
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_type');
    localStorage.removeItem('user_info');
    return next('/login');
  }
  
  // 权限控制：管理员页面只能管理员访问
  const adminPages = ['/dashboard', '/cases', '/persons', '/locations', '/officers', '/home'];
  if (adminPages.some(page => to.path.startsWith(page))) {
    if (userType !== '管理员') {
      ElMessage.warning('您没有权限访问此页面');
      return next('/user/home');
    }
  }
  
  // 用户页面只能普通用户访问
  const userPages = ['/user'];
  if (userPages.some(page => to.path.startsWith(page))) {
    if (userType === '管理员') {
      ElMessage.warning('管理员不能访问用户页面');
      return next('/dashboard');
    }
  }
  
  // 根路径重定向
  if (to.path === '/') {
    if (userType === '管理员') {
      return next('/dashboard');
    } else {
      return next('/user/home');
    }
  }
  
  next();
});

export default router