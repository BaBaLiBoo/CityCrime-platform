package com.example.crimeplatformapi.service;

import com.example.crimeplatformapi.entity.Persons;
import com.example.crimeplatformapi.exception.ResourceNotFoundException;
import com.example.crimeplatformapi.repository.CasePersonsRepository;
import com.example.crimeplatformapi.repository.PersonsRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Objects;

@Service
@SuppressWarnings("null")
public class PersonService {

    @Autowired
    private PersonsRepository personsRepository;

    @Autowired
    private CasePersonsRepository casePersonsRepository;

    public List<Persons> findAllPersons() {
        return personsRepository.findAll();
    }

    public Persons findById(String idNumber) {
        if (idNumber == null || idNumber.trim().isEmpty()) {
            throw new IllegalArgumentException("身份证号不能为空");
        }
        String trimmedId = idNumber.trim();
        return personsRepository.findById(trimmedId)
                .orElseThrow(() -> new ResourceNotFoundException("未找到身份证号为 " + trimmedId + " 的人员"));
    }

    @Transactional
    public Persons createPerson(Persons person) {
        validatePerson(person);
        String idNumber = Objects.requireNonNull(person.getIdNumber(), "身份证号不能为空").trim();
        if (personsRepository.existsById(idNumber)) {
            throw new IllegalArgumentException("身份证号 " + idNumber + " 已存在");
        }
        person.setIdNumber(idNumber);
        person.setName(Objects.requireNonNull(person.getName(), "姓名不能为空").trim());
        return personsRepository.save(person);
    }

    @Transactional
    public Persons update(String idNumber, Persons personDetails) {
        Persons existingPerson = findById(idNumber);
        if (personDetails.getName() == null || personDetails.getName().trim().isEmpty()) {
            throw new IllegalArgumentException("姓名不能为空");
        }
        
        existingPerson.setName(personDetails.getName().trim());
        existingPerson.setGender(personDetails.getGender());
        existingPerson.setBirthDate(personDetails.getBirthDate());
        existingPerson.setAddress(personDetails.getAddress());
        existingPerson.setContactInfo(personDetails.getContactInfo());

        return personsRepository.save(existingPerson);
    }

    @Transactional
    public void delete(String idNumber) {
        if (idNumber == null || idNumber.trim().isEmpty()) {
            throw new IllegalArgumentException("身份证号不能为空");
        }
        String trimmedId = idNumber.trim();
        if (!personsRepository.existsById(trimmedId)) {
            throw new ResourceNotFoundException("删除人员失败：未找到身份证号为 " + trimmedId + " 的人员");
        }
        casePersonsRepository.deleteByIdIdNumber(trimmedId);
        personsRepository.deleteById(trimmedId);
    }

    @Transactional
    public int deleteInvalidPersons() {
        List<Persons> invalidPersons = personsRepository.findInvalidPersons();
        for (Persons invalid : invalidPersons) {
            String id = invalid.getIdNumber();
            if (id != null && !id.trim().isEmpty()) {
                casePersonsRepository.deleteByIdIdNumber(id.trim());
            }
        }
        return personsRepository.deleteInvalidPersons();
    }

    private void validatePerson(Persons person) {
        if (person == null) {
            throw new IllegalArgumentException("人员信息不能为空");
        }
        if (person.getIdNumber() == null || person.getIdNumber().trim().isEmpty()) {
            throw new IllegalArgumentException("身份证号不能为空");
        }
        if (person.getName() == null || person.getName().trim().isEmpty()) {
            throw new IllegalArgumentException("姓名不能为空");
        }
    }
}